import { getLogger } from '../../../../lib/logger.js';
import { MessageAux } from '../dtx-message.js';
const log = getLogger('ApplicationListing');
/**
 * Application Listing service for retrieving installed applications
 */
export class ApplicationListing {
    dvt;
    static IDENTIFIER = 'com.apple.instruments.server.services.device.applictionListing';
    channel = null;
    constructor(dvt) {
        this.dvt = dvt;
    }
    /**
     * Initialize the application listing channel
     */
    async initialize() {
        if (this.channel) {
            return;
        }
        this.channel = await this.dvt.makeChannel(ApplicationListing.IDENTIFIER);
    }
    /**
     * Get the list of installed applications from the device
     * @returns {Promise<iOSApplication[]>}
     */
    async list() {
        await this.initialize();
        const args = new MessageAux().appendObj(null).appendObj(null);
        await this.channel.call('installedApplicationsMatching_registerUpdateToken_')(args);
        const result = await this.channel.receivePlist();
        if (!result) {
            log.warn('Received null/undefined response from installedApplicationsMatching');
            return [];
        }
        if (Array.isArray(result)) {
            return result;
        }
        throw new Error(`Unexpected response format from installedApplicationsMatching: ${JSON.stringify(result)}`);
    }
}
